<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文件上传测试</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; }
        .form-group { margin-bottom: 15px; }
        .result-box { margin-top: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .loading { background-color: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h3>文件上传测试</h3>
    
    <form id="uploadForm" action="http://10.114.226.195:5000/upload_new" method="post" enctype="multipart/form-data">
        <div class="form-group">
            <label for="file">选择文件:</label>
            <input type="file" id="file" name="file" required>
        </div>
        <button type="submit">上传文件</button>
    </form>

    <div id="resultBox" class="result-box" style="display: none;"></div>

    <script>
        document.getElementById('uploadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const resultBox = document.getElementById('resultBox');
            
            // 显示加载状态
            resultBox.innerHTML = '<div>正在上传文件，请稍候...</div>';
            resultBox.style.display = 'block';
            resultBox.className = 'result-box loading';

            let response; // 定义 response 变量，以便在 catch 块中使用
            try {
                // 设置超时时间为10秒
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                response = await fetch('http://192.168.0.10:5000/upload_new', {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                // 检查HTTP状态码
                if (!response.ok) {
                    throw new Error(`HTTP错误，状态码: ${response.status}`);
                }
                
                // 尝试解析JSON响应
                const data = await response.json();
                
                // 格式化并显示响应数据
                let resultHtml = `
                    <h4>${data.success ? '操作成功' : '操作失败'}</h4>
                    <p><strong>状态码:</strong> ${data.code}</p>
                    <p><strong>消息:</strong> ${data.message}</p>
                    <p><strong>时间戳:</strong> ${new Date(data.timestamp).toLocaleString()}</p>
                    <h5>详细结果:</h5>
                    <pre>${JSON.stringify(data.result, null, 2)}</pre>
                `;
                
                resultBox.innerHTML = resultHtml;
                resultBox.className = `result-box ${data.success ? 'success' : 'error'}`;
                
            } catch (error) {
                const timestamp = new Date().toISOString();
                let statusCode = null;
                let detailedResult = null;
                let message = `请求失败: ${error.message}`;

                // 尝试获取状态码和详细结果
                if (response) {
                    statusCode = response.status;
                    try {
                        detailedResult = await response.text();
                    } catch (parseError) {
                        detailedResult = '无法解析响应内容';
                    }
                }

                // 特殊处理网络错误
                if (error.name === 'AbortError') {
                    message = '请求超时，请检查网络连接';
                } else if (error.name === 'TypeError') {
                    message = '无法解析服务器响应，可能是跨域问题或服务器返回非JSON格式';
                }

                // 显示错误信息
                let errorHtml = `
                    <h4>操作失败</h4>
                    <p><strong>状态码:</strong> ${statusCode}</p>
                    <p><strong>消息:</strong> ${message}</p>
                    <p><strong>时间戳:</strong> ${new Date(timestamp).toLocaleString()}</p>
                    <h5>详细结果:</h5>
                    <pre>${JSON.stringify(detailedResult, null, 2)}</pre>
                `;

                resultBox.innerHTML = errorHtml;
                resultBox.className = 'result-box error';

                // 记录详细错误信息到控制台
                console.error('详细错误信息:', error);
            }
        });
    </script>
</body>
</html>